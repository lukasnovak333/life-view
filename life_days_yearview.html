
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Life Days — Year Click + Age Muting</title>
<style>
  :root{
    --bg: #0b0f14;
    --panel: #0f1620;
    --text: #e6eef8;
    --muted: #9fb0c3;
    --accent: #7aa2f7;
    --inactive: rgba(255,255,255,0.06);
    --vibrant-past: #5ac8fa;
    --vibrant-future: #4ade80;
    --vibrant-slow: #a3e635; /* not used now; we mute ≥60 regardless of slow */
    --sleep: rgba(255,255,255,0.28);
    --gridline: rgba(255,255,255,0.08);
    --monthline: rgba(255,255,255,0.16);
    --yearline: rgba(122,162,247,0.22);
    --label-current: #e6eef8;
    --label-past: #7f8ea1;
    --label-future: #5f7085;
    --today: #ef4444; /* red for today */
  }
  * { box-sizing: border-box; }
  body { margin: 0; background: var(--bg); color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  header{ padding: 8px 10px; border-bottom: 1px solid #1f2a37;
    background: linear-gradient(180deg,#0b0f14 0%, #0d121a 100%); }
  .top-row{ display:flex; align-items:center; gap:8px; justify-content:space-between; margin-bottom:6px; }
  h1{ margin:0; font-size: 16px; font-weight: 650; letter-spacing: .2px; }
  .btn{ background:#0b121b; color:var(--text); border:1px solid #263040; border-radius:8px; padding:6px 10px; cursor:pointer; }
  .btn:hover{ border-color:#385170; }
  .status-bar{ display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:6px; margin-bottom:6px; }
  .kpi{ background: var(--panel); border:1px solid #1f2a37; border-radius: 8px; padding:6px 8px; }
  .kpi .label{ font-size: 11px; color: var(--muted); }
  .kpi .value{ font-size: 16px; font-weight: 650; }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background: var(--panel); border:1px solid #1f2a37; border-radius: 10px; padding: 6px; }
  .control{ display:grid; gap:4px; min-width: 180px; }
  .control label{ font-size:11px; color: var(--muted); }
  input, select{ background:#0b121b; color:var(--text); border:1px solid #263040; border-radius:6px; padding:4px 6px; outline:none; height: 30px; }
  input[type="range"]{ width: 160px; height: auto; }
  .subtle{ color: var(--muted); font-size: 11px; }
  main{ padding: 8px 10px; }
  .canvas-wrap{ background: var(--panel); border:1px solid #1f2a37; border-radius: 10px; padding: 6px; overflow: auto; position: relative;
    height: calc(100vh - 160px); }
  .legend{ display:flex; gap:10px; flex-wrap: wrap; margin: 2px 4px 8px; font-size:11px; color: var(--muted); }
  .sw{ width: 14px; height: 10px; border-radius: 3px; display:inline-block; vertical-align:middle; margin-right:6px; }
  .floating-toggle{ position: fixed; top: 8px; right: 10px; z-index: 20; display:flex; gap:6px; }
  .floating-toggle .btn{ border-radius: 999px; padding:6px 10px; }
  .breadcrumb{ position:absolute; top:6px; left:8px; font-size:12px; color:var(--muted); background:rgba(0,0,0,0.25); padding:4px 8px; border-radius:8px; }
  .breadcrumb a{ color: var(--text); text-decoration: underline; cursor: pointer; }
  #dayView{ position:fixed; top:0; left:0; width:100vw; height:100vh; overflow-y:auto; display:none; scroll-snap-type:y mandatory; z-index:30; }
  #dayView .day{ width:100%; height:100vh; scroll-snap-align:start; }
  #dayView .breadcrumb{ position:fixed; top:6px; left:8px; font-size:12px; color:var(--muted); background:rgba(0,0,0,0.25); padding:4px 8px; border-radius:8px; z-index:40; }
  #dayView .breadcrumb a{ color: var(--text); text-decoration: underline; cursor: pointer; }
</style>
</head>
<body>
<header id="appHeader">
  <div class="top-row">
    <h1>Life Days — Year Click + Age Muting</h1>
    <div style="display:flex; gap:6px;">
      <button class="btn" id="hideStatusBtn" title="Hide status panel">Hide status</button>
      <button class="btn" id="hideControlsBtn" title="Hide controls panel">Hide controls</button>
      <button class="btn" id="fullscreenBtn" title="Toggle Fullscreen">Fullscreen</button>
      <button class="btn" id="exportBtn" title="Export PNG">Export PNG</button>
    </div>
  </div>

  <!-- Status / KPIs -->
  <section class="status-bar" id="statusBar">
    <div class="kpi"><div class="label">Age today</div><div class="value" id="ageToday">—</div></div>
    <div class="kpi"><div class="label">Days remaining</div><div class="value" id="daysRemain">—</div></div>
    <div class="kpi"><div class="label">Awake hours remaining</div><div class="value" id="awakeRemain">—</div></div>
    <div class="kpi"><div class="label">Quality-adjusted awake hours</div><div class="value" id="qaRemain">—</div></div>
  </section>

  <!-- Controls -->
  <section class="controls" id="controlsBar">
    <div class="control">
      <label>Birthdate</label>
      <input type="date" id="birth" value="1996-07-05"/>
    </div>
    <div class="control">
      <label>Death age</label>
      <div>
        <input type="range" id="deathAge" min="70" max="90" step="1" value="78"/>
        <input type="number" id="deathAgeNum" min="50" max="110" step="1" value="78"/>
      </div>
    </div>
    <div class="control">
      <label>Sleep (h/day)</label>
      <div>
        <input type="range" id="sleepHours" min="5" max="10" step="0.5" value="8"/>
        <input type="number" id="sleepHoursNum" min="0" max="24" step="0.5" value="8"/>
      </div>
    </div>
    <div class="control">
      <label>Cognitive curve</label>
      <select id="cogCurve">
        <option value="gentle" selected>Gentle slope</option>
        <option value="step">Step</option>
        <option value="linear">Linear</option>
        <option value="none">None</option>
      </select>
      <span class="subtle">Affects QA hours only.</span>
    </div>
    <div class="control">
      <label>Fit mode</label>
      <select id="fitMode">
        <option value="both" selected>Fit both</option>
        <option value="width">Fit width</option>
        <option value="height">Fit height</option>
        <option value="off">Off (zoom)</option>
      </select>
    </div>
    <div class="control">
      <label>Zoom (cell px)</label>
      <div>
        <input type="range" id="cellSize" min="2" max="14" step="1" value="6"/>
        <input type="number" id="cellSizeNum" min="1" max="24" step="1" value="6"/>
      </div>
    </div>
    <div class="control">
      <label>Year spacing (px)</label>
      <div>
        <input type="range" id="rowGap" min="0" max="8" step="1" value="2"/>
        <input type="number" id="rowGapNum" min="0" max="24" step="1" value="2"/>
      </div>
    </div>
    <div class="control">
      <label>Overlay</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <label class="subtle"><input type="checkbox" id="overlayMonth" checked> months</label>
        <label class="subtle"><input type="checkbox" id="overlayWeek"> weeks</label>
      </div>
    </div>
  </section>
</header>

<main>
  <section class="canvas-wrap" id="canvasWrap">
    <div class="legend">
      <span>Color scheme: <strong>muted</strong> &lt;18 and ≥60; <strong>vibrant</strong> 18–59; <span class="sw" style="background:var(--today)"></span> = today</span>
    </div>
    <canvas id="lifeCanvas" aria-label="Life days grid"></canvas>
    <div class="breadcrumb" id="breadcrumb" style="display:none;">Viewing <span id="yearLabel"></span> — <a id="backToAll">back to all years</a></div>
  </section>
</main>

<div id="dayView">
  <div class="breadcrumb">Viewing <span id="dayYearLabel"></span> — <a id="dayBack">back to all years</a></div>
</div>

<div class="floating-toggle">
  <button class="btn" id="showStatusBtn" title="Show status" style="display:none;">Show status</button>
  <button class="btn" id="showControlsBtn" title="Show controls" style="display:none;">Show controls</button>
</div>

<script>
// ---------- Utilities ----------
function parseDateYYYYMMDD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }
function formatNumber(n){ return n.toLocaleString(); }
function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
function daysBetween(a,b){ const MS=24*3600*1000; return Math.round((b - a)/MS); }
function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }
function ageOn(date, birth){
  let y = date.getFullYear() - birth.getFullYear();
  const bdThisYear = new Date(date.getFullYear(), birth.getMonth(), birth.getDate());
  if(date < bdThisYear) y--;
  const lastBD = new Date(birth.getFullYear()+y, birth.getMonth(), birth.getDate());
  const nextBD = new Date(lastBD.getFullYear()+1, lastBD.getMonth(), lastBD.getDate());
  const daysSince = daysBetween(lastBD, date);
  const yearDays = daysBetween(lastBD, nextBD);
  return y + (daysSince / yearDays);
}
function birthdayAtAge(birth, age){
  const y = Math.floor(age);
  const frac = age - y;
  const bdBase = new Date(birth.getFullYear() + y, birth.getMonth(), birth.getDate());
  const next = new Date(bdBase.getFullYear()+1, bdBase.getMonth(), bdBase.getDate());
  const days = daysBetween(bdBase, next);
  return addDays(bdBase, Math.round(frac * days));
}
function lerp(a,b,t){ return a + (b-a)*t; }
function cognitiveWeight(age, curveType, deathAge){
  if(curveType === 'none') return 1.0;
  if(curveType === 'step') return age < 60 ? 1.0 : 0.6;
  if(curveType === 'linear'){
    if(age <= 30) return 1.0;
    const t = Math.min(1, Math.max(0, (age - 30) / Math.max(1, (deathAge - 30))));
    return lerp(1.0, 0.6, t);
  }
  // gentle
  const pts = [
    {a: 0, w: 1.0},
    {a: 30, w: 1.0},
    {a: 45, w: 0.9},
    {a: 60, w: 0.8},
    {a: 75, w: 0.6},
    {a: 85, w: 0.5},
    {a: Math.max(90, deathAge), w: 0.5}
  ];
  for(let i=0;i<pts.length-1;i++){
    if(age >= pts[i].a && age <= pts[i+1].a){
      const t = (age - pts[i].a) / Math.max(1e-9, (pts[i+1].a - pts[i].a));
      return lerp(pts[i].w, pts[i+1].w, t);
    }
  }
  return 0.5;
}

// ---------- State ----------
let viewMode = 'life'; // 'life' or 'year'
let selectedYear = null;

// ---------- Renderer ----------
const canvas = document.getElementById('lifeCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvasWrap');
const header = document.getElementById('appHeader');
const statusBar = document.getElementById('statusBar');
const controlsBar = document.getElementById('controlsBar');
const hideStatusBtn = document.getElementById('hideStatusBtn');
const hideControlsBtn = document.getElementById('hideControlsBtn');
const showStatusBtn = document.getElementById('showStatusBtn');
const showControlsBtn = document.getElementById('showControlsBtn');
const breadcrumb = document.getElementById('breadcrumb');
const yearLabel = document.getElementById('yearLabel');
const backToAll = document.getElementById('backToAll');
const dayView = document.getElementById('dayView');
const dayYearLabel = document.getElementById('dayYearLabel');
const dayBack = document.getElementById('dayBack');

function recompute(){
  const birth = parseDateYYYYMMDD(document.getElementById('birth').value);
  const deathAge = parseFloat(document.getElementById('deathAge').value);
  const sleep = parseFloat(document.getElementById('sleepHours').value);
  const curve = document.getElementById('cogCurve').value;
  const fitMode = document.getElementById('fitMode').value;
  const rowGap = parseInt(document.getElementById('rowGap').value, 10);
  const overlayMonth = document.getElementById('overlayMonth').checked;
  const overlayWeek = document.getElementById('overlayWeek').checked;
  let cell = parseInt(document.getElementById('cellSize').value, 10);
  const now = new Date();
  const nowMid = new Date(now); nowMid.setHours(12,0,0,0);
  const todayY = nowMid.getFullYear();

  const deathDate = birthdayAtAge(birth, deathAge);

  // KPIs
  const MS = 24*3600*1000;
  const awakePerDay = Math.max(0, 24 - sleep);
  const daysRemain = Math.max(0, Math.ceil((deathDate - nowMid)/MS));
  let qaHoursRemain = 0, awakeHoursRemain = 0, awakePast = 0;

  // Sum over days
  {
    // Future
    let d = new Date(nowMid);
    const end = new Date(deathDate); end.setHours(12,0,0,0);
    while(d < end){
      const a = ageOn(d, birth);
      const w = cognitiveWeight(a, curve, deathAge);
      qaHoursRemain += awakePerDay * w;
      awakeHoursRemain += awakePerDay;
      d = addDays(d, 1);
    }
    // Past
    let p = new Date(birth); p.setHours(12,0,0,0);
    const pend = new Date(nowMid);
    while(p < pend){
      awakePast += awakePerDay;
      p = addDays(p, 1);
    }
  }

  // Update KPIs
  document.getElementById('ageToday').textContent = ageOn(nowMid, birth).toFixed(2) + ' yrs';
  document.getElementById('daysRemain').textContent = formatNumber(daysRemain) + ' days';
  document.getElementById('awakeRemain').textContent = formatNumber(Math.round(awakeHoursRemain));
  document.getElementById('qaRemain').textContent = formatNumber(Math.round(qaHoursRemain));

  if(viewMode === 'year'){
    wrap.style.display = 'none';
    renderDayView(selectedYear, birth, deathAge, nowMid);
    return;
  } else {
    wrap.style.display = 'block';
    dayView.style.display = 'none';
  }

  // ---- Canvas sizing ----
  function adjustWrapHeight(){
    const headerH = header.getBoundingClientRect().height;
    wrap.style.height = `calc(100vh - ${Math.ceil(headerH) + 10}px)`;
  }
  adjustWrapHeight();

  const deviceScale = window.devicePixelRatio || 1;
  const padding = 8;
  const gutter = 48;

  // Determine rows/years depending on view
  const startYear = birth.getFullYear();
  const endYear = Math.ceil(birth.getFullYear() + deathAge);
  const years = endYear - startYear + 1;
  const maxCols = 366;

  // Fit calc
  if(viewMode === 'life'){
    const containerWidth = wrap.clientWidth - 2*padding - gutter - 8;
    const containerHeight = wrap.clientHeight - 2*padding - (years-1)*rowGap;
    const cellFromWidth = Math.floor(containerWidth / maxCols);
    const cellFromHeight = Math.floor(containerHeight / years);
    if(fitMode === 'width'){ cell = Math.max(1, cellFromWidth); }
    else if(fitMode === 'height'){ cell = Math.max(1, cellFromHeight); }
    else if(fitMode === 'both'){ cell = Math.max(1, Math.min(cellFromWidth, cellFromHeight)); }
    document.getElementById('cellSize').value = cell;
    document.getElementById('cellSizeNum').value = cell;
  } else { // year view
    const containerWidth = wrap.clientWidth - 2*padding - gutter - 8;
    const containerHeight = wrap.clientHeight - 2*padding;
    const daysInYear = daysBetween(new Date(selectedYear,0,1), new Date(selectedYear+1,0,1));
    const cellFromWidth = Math.floor(containerWidth / daysInYear);
    const cellFromHeight = Math.floor(containerHeight); // one row fills height
    // In year mode, height drives cell height, width drives width; choose min to fit both constraints
    cell = Math.max(1, Math.min(cellFromWidth, cellFromHeight));
  }

  const sleepStripeH = Math.max(1, Math.round((sleep/24) * cell));

  let w, h;
  if(viewMode === 'life'){
    w = gutter + maxCols * cell + padding*2;
    h = years * cell + (years-1)*rowGap + padding*2;
  } else {
    const daysInYear = daysBetween(new Date(selectedYear,0,1), new Date(selectedYear+1,0,1));
    w = gutter + daysInYear * cell + padding*2;
    h = 1 * cell + padding*2;
  }

  canvas.width = Math.floor(w * deviceScale);
  canvas.height = Math.floor(h * deviceScale);
  canvas.style.width = Math.floor(w) + 'px';
  canvas.style.height = Math.floor(h) + 'px';
  ctx.setTransform(deviceScale, 0, 0, deviceScale, 0, 0);
  ctx.clearRect(0,0,w,h);

  // Colors
  const colorInactive = getComputedStyle(document.documentElement).getPropertyValue('--inactive').trim();
  const vibrantPast = getComputedStyle(document.documentElement).getPropertyValue('--vibrant-past').trim();
  const vibrantFuture = getComputedStyle(document.documentElement).getPropertyValue('--vibrant-future').trim();
  const sleepColor = getComputedStyle(document.documentElement).getPropertyValue('--sleep').trim();
  const gridline = getComputedStyle(document.documentElement).getPropertyValue('--gridline').trim();
  const monthline = getComputedStyle(document.documentElement).getPropertyValue('--monthline').trim();
  const yearline = getComputedStyle(document.documentElement).getPropertyValue('--yearline').trim();
  const labelCurrent = getComputedStyle(document.documentElement).getPropertyValue('--label-current').trim();
  const labelPast = getComputedStyle(document.documentElement).getPropertyValue('--label-past').trim();
  const labelFuture = getComputedStyle(document.documentElement).getPropertyValue('--label-future').trim();
  const todayColor = getComputedStyle(document.documentElement).getPropertyValue('--today').trim();

  // Background
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim();
  ctx.fillRect(0,0,w,h);
  ctx.font = "10px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textBaseline = 'middle';

  const birthMid = new Date(birth); birthMid.setHours(12,0,0,0);
  const deathMid = new Date(deathDate); deathMid.setHours(12,0,0,0);

  function baseColorFor(date){
    const a = ageOn(date, birth);
    const isPast = date < nowMid;
    // Vibrant base: past vs future
    const base = isPast ? vibrantPast : vibrantFuture;
    // Age-based muting: mute <18 and >=60 by lowering alpha later
    const muted = (a < 18) || (a >= 60);
    return { base, muted };
  }

  if(viewMode === 'life'){
    // Draw all years
    let yCursor = padding;
    for(let y=0; y<years; y++){
      const yearVal = startYear + y;
      const yearStart = new Date(yearVal, 0, 1);
      const yearEnd = new Date(yearVal+1, 0, 1);
      const daysInYear = daysBetween(yearStart, yearEnd);

      // Label: yr N
      const ageAtJan1 = (yearVal - birth.getFullYear());
      const labelColor = yearVal < todayY ? labelPast : (yearVal > todayY ? labelFuture : labelCurrent);
      ctx.fillStyle = labelColor;
      ctx.fillText(`yr ${ageAtJan1}`, 6, yCursor + cell/2);

      // Row guide
      ctx.strokeStyle = yearline;
      ctx.beginPath();
      ctx.moveTo(gutter, Math.floor(yCursor-1)+0.5);
      ctx.lineTo(w - padding, Math.floor(yCursor-1)+0.5);
      ctx.stroke();

      // Days
      let xCursor = gutter;
      for(let d=0; d<daysInYear; d++){
        const date = addDays(yearStart, d);
        if(date < birthMid || date >= deathMid){
          ctx.fillStyle = colorInactive;
          ctx.fillRect(xCursor, yCursor, cell, cell);
          xCursor += cell; continue;
        }
        const bc = baseColorFor(date);
        ctx.globalAlpha = bc.muted ? 0.35 : 1.0;
        ctx.fillStyle = bc.base;
        ctx.fillRect(xCursor, yCursor, cell, cell);

        // Sleep stripe
        if(sleepStripeH > 0){
          ctx.fillStyle = sleepColor;
          ctx.fillRect(xCursor, yCursor, cell, sleepStripeH);
        }
        ctx.globalAlpha = 1.0;

        // Today highlight
        if(date.getTime() === nowMid.getTime()){
          ctx.fillStyle = todayColor;
          ctx.fillRect(xCursor, yCursor, cell, cell);
        }

        xCursor += cell;
      }

      // Overlays
      if(overlayMonth){
        ctx.strokeStyle = monthline; ctx.lineWidth = 1;
        for(let m=1; m<12; m++){
          const x = gutter + daysBetween(yearStart, new Date(yearVal, m, 1)) * cell + 0.5;
          ctx.beginPath(); ctx.moveTo(x, yCursor); ctx.lineTo(x, yCursor + cell); ctx.stroke();
        }
      }
      if(overlayWeek){
        ctx.strokeStyle = gridline; ctx.lineWidth = 1;
        for(let wi=7; wi<daysInYear; wi+=7){
          const x = gutter + wi * cell + 0.5;
          ctx.beginPath(); ctx.moveTo(x, yCursor); ctx.lineTo(x, yCursor + cell); ctx.stroke();
        }
      }

      yCursor += cell + rowGap;
    }
  } else {
    // Single year view
    const y = selectedYear;
    const yearStart = new Date(y, 0, 1);
    const yearEnd = new Date(y+1, 0, 1);
    const daysInYear = daysBetween(yearStart, yearEnd);

    // Breadcrumb
    breadcrumb.style.display = 'block';
    yearLabel.textContent = y;

    // Label: yr N at left
    const ageAtJan1 = (y - birth.getFullYear());
    const labelColor = y < todayY ? labelPast : (y > todayY ? labelFuture : labelCurrent);
    ctx.fillStyle = labelColor;
    ctx.fillText(`yr ${ageAtJan1}`, 6, padding + cell/2);

    // Row guide
    ctx.strokeStyle = yearline;
    ctx.beginPath(); ctx.moveTo(gutter, Math.floor(padding-1)+0.5); ctx.lineTo(w - padding, Math.floor(padding-1)+0.5); ctx.stroke();

    // Draw days in one tall row (fills height)
    let xCursor = gutter;
    const yCursor = padding;
    for(let d=0; d<daysInYear; d++){
      const date = addDays(yearStart, d);
      if(date < birthMid || date >= deathMid){
        ctx.fillStyle = colorInactive;
        ctx.fillRect(xCursor, yCursor, cell, cell);
        xCursor += cell; continue;
      }
      const bc = baseColorFor(date);
      ctx.globalAlpha = bc.muted ? 0.35 : 1.0;
      ctx.fillStyle = bc.base;
      ctx.fillRect(xCursor, yCursor, cell, cell);

      // Sleep stripe
      if(sleepStripeH > 0){
        ctx.fillStyle = sleepColor;
        ctx.fillRect(xCursor, yCursor, cell, sleepStripeH);
      }
      ctx.globalAlpha = 1.0;

      // Today highlight
      if(date.getTime() === nowMid.getTime()){
        ctx.fillStyle = todayColor;
        ctx.fillRect(xCursor, yCursor, cell, cell);
      }

      xCursor += cell;
    }

    // Overlays
    if(overlayMonth){
      ctx.strokeStyle = monthline; ctx.lineWidth = 1;
      for(let m=1; m<12; m++){
        const x = gutter + daysBetween(yearStart, new Date(y, m, 1)) * cell + 0.5;
        ctx.beginPath(); ctx.moveTo(x, yCursor); ctx.lineTo(x, yCursor + cell); ctx.stroke();
      }
    }
    if(overlayWeek){
      ctx.strokeStyle = gridline; ctx.lineWidth = 1;
      for(let wi=7; wi<daysInYear; wi+=7){
        const x = gutter + wi * cell + 0.5;
        ctx.beginPath(); ctx.moveTo(x, yCursor); ctx.lineTo(x, yCursor + cell); ctx.stroke();
      }
    }
  }

  if(viewMode === 'life'){
    setupInteractions(birth, startYear, years, cell, rowGap, gutter, padding);
  }
}

// Hover + click
let hoverDiv = null;
function setupInteractions(birth, startYear, years, cell, rowGap, gutter, padding){
  const now = new Date(); const nowMid = new Date(now); nowMid.setHours(12,0,0,0);
  if(!hoverDiv){
    hoverDiv = document.createElement('div');
    hoverDiv.style.position = 'fixed';
    hoverDiv.style.pointerEvents = 'none';
    hoverDiv.style.background = 'rgba(0,0,0,0.8)';
    hoverDiv.style.color = 'white';
    hoverDiv.style.fontSize = '12px';
    hoverDiv.style.padding = '6px 8px';
    hoverDiv.style.borderRadius = '6px';
    hoverDiv.style.zIndex = '10';
    hoverDiv.style.display = 'none';
    document.body.appendChild(hoverDiv);
  }
  canvas.onmousemove = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // Life mode: compute row/year
    if(viewMode === 'life'){
      const rowHeight = cell + rowGap;
      const relY = y - padding;
      if(relY < 0){ hoverDiv.style.display='none'; return; }
      const row = Math.floor(relY / rowHeight);
      if(row < 0 || row >= years){ hoverDiv.style.display='none'; return; }
      const yInRow = relY - row*rowHeight;
      if(yInRow > cell){ hoverDiv.style.display='none'; return; }
      const relX = x - gutter; if(relX < 0){ hoverDiv.style.display='none'; return; }
      const dayIdx = Math.floor(relX / cell);
      const yearVal = startYear + row;
      const yearStart = new Date(yearVal, 0, 1);
      const daysInYear = (new Date(yearVal+1,0,1) - yearStart)/(24*3600*1000);
      if(dayIdx < 0 || dayIdx >= daysInYear){ hoverDiv.style.display='none'; return; }
      const theDate = addDays(yearStart, dayIdx);
      const ageFloat = ageOn(theDate, birth);
      hoverDiv.textContent = `${theDate.toDateString()} — age ${ageFloat.toFixed(2)}`;
      hoverDiv.style.left = (e.clientX + 12) + 'px';
      hoverDiv.style.top = (e.clientY + 12) + 'px';
      hoverDiv.style.display = 'block';
    } else {
      // Year mode
      const relX = x - gutter; if(relX < 0){ hoverDiv.style.display='none'; return; }
      const dayIdx = Math.floor(relX / cell);
      const yStart = new Date(selectedYear, 0, 1);
      const daysInYear = (new Date(selectedYear+1,0,1) - yStart)/(24*3600*1000);
      if(dayIdx < 0 || dayIdx >= daysInYear){ hoverDiv.style.display='none'; return; }
      const theDate = addDays(yStart, dayIdx);
      const ageFloat = ageOn(theDate, birth);
      hoverDiv.textContent = `${theDate.toDateString()} — age ${ageFloat.toFixed(2)}`;
      hoverDiv.style.left = (e.clientX + 12) + 'px';
      hoverDiv.style.top = (e.clientY + 12) + 'px';
      hoverDiv.style.display = 'block';
    }
  };
  canvas.onmouseleave = ()=>{ hoverDiv.style.display='none'; };

  // Click to enter/exit year view
  canvas.onclick = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    if(viewMode === 'life'){
      const rowHeight = cell + rowGap;
      const relY = y - padding;
      if(relY < 0) return;
      const row = Math.floor(relY / rowHeight);
      if(row < 0 || row >= years) return;
      const yInRow = relY - row*rowHeight;
      if(yInRow > cell) return;
      selectedYear = startYear + row;
      viewMode = 'year';
      document.getElementById('breadcrumb').style.display = 'block';
      recompute();
    } else {
      // In year view, clicking anywhere returns to life? We'll use breadcrumb for back; ignore here.
    }
  };
}

function renderDayView(year, birth, deathAge, nowMid){
  dayView.style.display = 'block';
  dayYearLabel.textContent = year;
  Array.from(dayView.querySelectorAll('.day')).forEach(el=>el.remove());
  const birthMid = new Date(birth); birthMid.setHours(12,0,0,0);
  const deathDate = new Date(birth.getFullYear() + deathAge, birth.getMonth(), birth.getDate());
  const deathMid = new Date(deathDate); deathMid.setHours(12,0,0,0);
  const colorInactive = getComputedStyle(document.documentElement).getPropertyValue('--inactive').trim();
  const vibrantPast = getComputedStyle(document.documentElement).getPropertyValue('--vibrant-past').trim();
  const vibrantFuture = getComputedStyle(document.documentElement).getPropertyValue('--vibrant-future').trim();
  const todayColor = getComputedStyle(document.documentElement).getPropertyValue('--today').trim();
  const yearStart = new Date(year,0,1);
  const yearEnd = new Date(year+1,0,1);
  const daysInYear = daysBetween(yearStart, yearEnd);
  for(let d=0; d<daysInYear; d++){
    const date = addDays(yearStart, d);
    const div = document.createElement('div');
    div.className = 'day';
    if(date < birthMid || date >= deathMid){
      div.style.background = colorInactive;
    } else {
      const isPast = date < nowMid;
      const base = isPast ? vibrantPast : vibrantFuture;
      const muted = (ageOn(date, birth) < 18) || (ageOn(date, birth) >= 60);
      div.style.background = (date.getTime() === nowMid.getTime()) ? todayColor : base;
      if(muted && date.getTime() !== nowMid.getTime()) div.style.opacity = 0.35;
    }
    dayView.appendChild(div);
  }
}

document.getElementById('backToAll').addEventListener('click', ()=>{
  viewMode = 'life'; selectedYear = null;
  document.getElementById('breadcrumb').style.display = 'none';
  recompute();
});

dayBack.addEventListener('click', ()=>{
  viewMode = 'life'; selectedYear = null; recompute();
});

// Link controls
function linkRangeNumber(rangeId, numId, onChange){
  const rng = document.getElementById(rangeId);
  const num = document.getElementById(numId);
  rng.addEventListener('input', ()=>{ num.value = rng.value; onChange(); });
  num.addEventListener('input', ()=>{
    const v = clamp(parseInt(num.value||0,10), parseInt(rng.min,10), parseInt(rng.max,10));
    rng.value = v; num.value = v; onChange();
  });
}
linkRangeNumber('deathAge','deathAgeNum',()=>{ if(viewMode==='year') viewMode='life'; recompute(); });
linkRangeNumber('sleepHours','sleepHoursNum',recompute);
linkRangeNumber('cellSize','cellSizeNum',()=>{ if(document.getElementById('fitMode').value==='off') recompute(); });

document.getElementById('rowGap').addEventListener('input', ()=>{ document.getElementById('rowGapNum').value = document.getElementById('rowGap').value; recompute(); });
document.getElementById('rowGapNum').addEventListener('input', ()=>{
  const v = clamp(parseInt(document.getElementById('rowGapNum').value||0,10), parseInt(document.getElementById('rowGap').min,10), parseInt(document.getElementById('rowGap').max,10));
  document.getElementById('rowGap').value = v; recompute();
});
['birth','cogCurve','fitMode','overlayMonth','overlayWeek'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{ if(viewMode==='year' && id!=='overlayMonth' && id!=='overlayWeek') viewMode='life'; recompute(); }));

// Panel show/hide
hideStatusBtn.addEventListener('click', ()=>{
  statusBar.style.display = 'none';
  document.getElementById('showStatusBtn').style.display = 'inline-block';
  recompute();
});
hideControlsBtn.addEventListener('click', ()=>{
  controlsBar.style.display = 'none';
  document.getElementById('showControlsBtn').style.display = 'inline-block';
  recompute();
});
showStatusBtn.addEventListener('click', ()=>{
  statusBar.style.display = 'grid';
  document.getElementById('showStatusBtn').style.display = 'none';
  recompute();
});
showControlsBtn.addEventListener('click', ()=>{
  controlsBar.style.display = 'flex';
  document.getElementById('showControlsBtn').style.display = 'none';
  recompute();
});

// Fullscreen + export
document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
  const el = document.documentElement;
  if(!document.fullscreenElement){
    if(el.requestFullscreen) el.requestFullscreen();
  }else{
    if(document.exitFullscreen) document.exitFullscreen();
  }
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url; a.download = (viewMode==='life' ? 'life_all_years.png' : `life_year_${selectedYear}.png`); a.click();
});

// Initial render + resize handling
recompute();
window.addEventListener('resize', recompute);
document.addEventListener('fullscreenchange', recompute);
</script>
</body>
</html>
